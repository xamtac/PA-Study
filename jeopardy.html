<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jeopardy Game | OB/GYN Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Jeopardy-style game using OB/GYN questions from a JSON file." />
  <meta name="keywords" content="PANCE, OB/GYN, jeopardy, quiz, game" />
  <meta name="author" content="M & M Consulting" />

  <!-- Reuse your existing shared CSS -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Header with Navigation -->
  <header>
    <nav class="top-nav" role="navigation" aria-label="Main navigation">
      <h2 class="visually-hidden">Main Navigation</h2>
      <div class="nav-brand">
        <a href="home.html" aria-label="Go to home page">M & M Consulting</a>
      </div>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
        &#9776;
      </button>
      <ul class="nav-links" id="nav-links">
        <li><a href="home.html">Home</a></li>
        <li><a href="index.html">Quizzes</a></li>
        <li><a href="studyguides.html">Study Guides</a></li>
        <li><a href="summary.html">Quiz Summary</a></li>
        <li><a href="jeopardy.html">Jeopardy</a></li>
      </ul>
    </nav>
  </header>

  <main class="page-container" role="main">
    <h1>OB/GYN Jeopardy Game</h1>

    <!-- Scoreboard for each player -->
    <section id="scoreboard" style="text-align: center; margin-bottom: 1rem;">
      <!-- Populated dynamically via JS -->
    </section>

    <!-- Jeopardy Board -->
    <section id="jeopardy-board" style="overflow-x:auto; margin-bottom: 1rem;">
      <!-- 5 columns with 5 rows, generated by JS -->
    </section>

    <!-- Reset Button -->
    <div style="text-align: center;">
      <button id="resetGameBtn">Reset Game</button>
    </div>
  </main>

  <!-- Modal for showing a question -->
  <div id="modalOverlay"
       style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
              background:rgba(0,0,0,0.5); z-index:998;">
  </div>
  
  <div id="questionModal"
       style="display:none; position:fixed; top:50%; left:50%;
              transform:translate(-50%,-50%); background:#fff;
              padding:1rem; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.2);
              z-index:999; max-width:600px; width:90%;">
    <h2 id="modalCategory"></h2>
    <p><strong id="modalQuestion"></strong></p>
    <p class="daily-double-message" id="dailyDoubleMsg" style="font-weight: bold; color: #d9534f; display:none;">
      <!-- Shown only if this is a Daily Double question -->
    </p>
    <p><em id="currentPlayerLabel"></em></p>

    <!-- “Show Answer” button; initially visible -->
    <div style="text-align:center; margin: 1rem 0;">
      <button id="showAnswerBtn" style="background:#FFA500;">Show Answer</button>
    </div>

    <!-- Reveals the correct answer once "Show Answer" is clicked -->
    <p id="modalAnswer" style="text-align:center; font-weight:bold; display:none;">
      <!-- Correct answer text is inserted here -->
    </p>

    <!-- Once the answer is revealed, these appear: -->
    <div id="answerButtons" style="text-align:center; display:none;">
      <button id="correctBtn" style="background:green; margin-right: 1rem;">Correct</button>
      <button id="wrongBtn" style="background:red;">Wrong</button>
    </div>
  </div>

  <footer class="site-footer">
    <p>&copy; <span id="currentYear"></span> M & M Consulting. All rights reserved. Xamtac is the best.</p>
  </footer>

  <script>
    "use strict";

    // Mobile Nav Toggle
    const navToggle = document.getElementById("nav-toggle");
    const navLinks = document.getElementById("nav-links");
    if(navToggle) {
      navToggle.addEventListener("click", () => {
        const expanded = navToggle.getAttribute("aria-expanded") === "true";
        navToggle.setAttribute("aria-expanded", String(!expanded));
        navLinks.classList.toggle("open");
      });
    }

    // Year in Footer
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    // -------------------------------------------------------------
    // Jeopardy Game Logic
    // -------------------------------------------------------------
    const categories = ["Obstetrics", "Postpartum", "Gynecology", "Oncology", "Infections"];
    const moneyValues = [200, 400, 600, 800, 1000]; 
    let numberOfPlayers = 1;
    let currentPlayer = 0; // index from 0..(numberOfPlayers-1)
    let scores = [];
    let questionBoard = {}; // category -> array of Q objects
    let dailyDoubleIndices = [];

    // DOM elements
    const scoreboardEl = document.getElementById("scoreboard");
    const boardEl = document.getElementById("jeopardy-board");
    const questionModal = document.getElementById("questionModal");
    const modalOverlay = document.getElementById("modalOverlay");
    const modalCategoryEl = document.getElementById("modalCategory");
    const modalQuestionEl = document.getElementById("modalQuestion");
    const dailyDoubleMsg = document.getElementById("dailyDoubleMsg");
    const modalAnswerEl = document.getElementById("modalAnswer");
    const currentPlayerLabel = document.getElementById("currentPlayerLabel");
    const showAnswerBtn = document.getElementById("showAnswerBtn");
    const correctBtn = document.getElementById("correctBtn");
    const wrongBtn = document.getElementById("wrongBtn");
    const answerButtons = document.getElementById("answerButtons");
    const resetGameBtn = document.getElementById("resetGameBtn");

    // On page load
    window.addEventListener("load", () => {
      initializeGame();
    });

    // Reset button event
    resetGameBtn.addEventListener("click", () => {
      initializeGame(true);
    });

    async function initializeGame(isReset = false) {
      // Ask how many players
      const userInput = prompt("How many players? (1-4)", "1");
      let n = parseInt(userInput, 10);
      if(isNaN(n) || n < 1 || n > 4) n = 1;
      numberOfPlayers = n;

      // Reset scores and current player
      scores = new Array(numberOfPlayers).fill(0);
      currentPlayer = 0;

      // Clear scoreboard & board
      scoreboardEl.innerHTML = "";
      boardEl.innerHTML = "";

      // Hide modal if open
      hideModal();

      // Build scoreboard
      buildScoreboard();

      // Fetch and prepare questions
      const data = await fetchQuestions();
      // Group by classification
      const byCategory = {
        "Obstetrics": [],
        "Postpartum": [],
        "Gynecology": [],
        "Oncology": [],
        "Infections": []
      };

      data.forEach(q => {
        if (byCategory.hasOwnProperty(q.classification)) {
          byCategory[q.classification].push(q);
        }
      });

      // For each category, pick 5 questions (shuffle & repeat if not enough)
      questionBoard = {};
      categories.forEach(cat => {
        let arr = byCategory[cat];
        if (!arr || arr.length === 0) {
          // fallback if no matches
          arr = [{
            question: "No question available",
            answer: "A",
            choices: ["A","B","C","D"],
            id:"dummy"
          }];
        }
        shuffleArray(arr);
        let selected = [];
        for (let i=0; i<5; i++){
          selected.push(arr[i % arr.length]);
        }
        // Build final objects
        questionBoard[cat] = selected.map((q, idx) => {
          return {
            ...q,
            used: false,
            money: moneyValues[idx],
            isDouble: false
          };
        });
      });

      // Assign 2 daily doubles across entire board
      dailyDoubleIndices = [];
      const totalSquares = 5 * 5; // 25
      let chosenSet = new Set();
      while (chosenSet.size < 2) {
        chosenSet.add(Math.floor(Math.random() * totalSquares));
      }
      dailyDoubleIndices = [...chosenSet];

      // Build the board
      buildJeopardyBoard();

      if (isReset) {
        alert("Game has been reset. Good luck!");
      }
    }

    function buildScoreboard() {
      let html = '<div style="display:flex; justify-content:center; gap:2rem;">';
      for (let i=0; i<numberOfPlayers; i++) {
        html += `
          <div style="min-width:80px;">
            <div><strong>Player ${i+1}</strong></div>
            <div id="playerScore${i}" style="font-size:1.2rem;">$0</div>
          </div>
        `;
      }
      html += "</div>";
      scoreboardEl.innerHTML = html;
    }

    function updateScoreboard() {
      for (let i=0; i<numberOfPlayers; i++) {
        const el = document.getElementById("playerScore"+i);
        if (el) {
          el.textContent = "$" + scores[i];
        }
      }
    }

    function buildJeopardyBoard() {
      let tableHTML = '<table style="margin:0 auto; border-collapse: collapse;">';

      // Table header (categories)
      tableHTML += "<thead><tr>";
      categories.forEach(cat => {
        tableHTML += `
          <th style="
               border:1px solid #333; padding:0.5rem;
               min-width:120px; background:#333; color:#fff;
               text-transform:uppercase;"
          >
            ${cat}
          </th>`;
      });
      tableHTML += "</tr></thead>";

      // Table body
      tableHTML += "<tbody>";
      for (let row=0; row<5; row++) {
        tableHTML += "<tr>";
        for (let col=0; col<5; col++){
          const cat = categories[col];
          const questionObj = questionBoard[cat][row];
          const indexInBoard = row * 5 + col;
          // Mark daily double behind the scenes
          const isDD = dailyDoubleIndices.includes(indexInBoard);
          questionObj.isDouble = isDD;

          // We no longer show "DD" in the cell (per request)
          tableHTML += `
            <td id="cell-${cat}-${row}"
                style="
                  border:1px solid #ccc; padding:1rem;
                  text-align:center; background:#007BFF;
                  color:#fff; cursor:pointer;"
                onclick="openQuestion('${cat}', ${row})"
            >
              $${questionObj.money}
            </td>
          `;
        }
        tableHTML += "</tr>";
      }
      tableHTML += "</tbody></table>";
      boardEl.innerHTML = tableHTML;
    }

    // Expose to global scope so onclick attribute works
    window.openQuestion = function(category, rowIndex) {
      const qObj = questionBoard[category][rowIndex];
      if (qObj.used) {
        // Already used
        return;
      }
      showModal(category, rowIndex);
    };

    function showModal(category, rowIndex) {
      const qObj = questionBoard[category][rowIndex];
      modalCategoryEl.textContent = category;
      modalQuestionEl.textContent = qObj.question;
      currentPlayerLabel.textContent = `Current Player: Player ${currentPlayer+1}`;

      // If daily double, show special message
      if (qObj.isDouble) {
        dailyDoubleMsg.textContent = "Daily Double! This question is worth double.";
        dailyDoubleMsg.style.display = "block";
      } else {
        dailyDoubleMsg.style.display = "none";
        dailyDoubleMsg.textContent = "";
      }

      // Hide the answer + correct/wrong buttons until user clicks "Show Answer"
      modalAnswerEl.style.display = "none";
      modalAnswerEl.textContent = ""; 
      answerButtons.style.display = "none";

      questionModal.style.display = "block";
      modalOverlay.style.display = "block";

      // “Show Answer” button reveals the correct answer text 
      showAnswerBtn.onclick = () => {
        // Determine the correct letter index
        const correctLetter = qObj.answer; // e.g. 'A'
        const correctIndex = correctLetter.charCodeAt(0) - 65; // 0-based index
        const correctChoice = qObj.choices[correctIndex] || "(No data)";

        modalAnswerEl.textContent = `Correct Answer: ${correctChoice}`;
        modalAnswerEl.style.display = "block";
        answerButtons.style.display = "block";
      };

      // Correct / Wrong assignment
      correctBtn.onclick = () => {
        handleAnswer(true, category, rowIndex);
      };
      wrongBtn.onclick = () => {
        ha